name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Build New Binary
        shell: powershell
        run: |
          # 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          if (!$mainFile) { throw "Fatal: main.go not found!" }
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot
          Write-Host "ğŸ  Project Root: $projectRoot"

          # 2. ë¹Œë“œ ë¨¼ì € ìˆ˜í–‰ (ê¸°ì¡´ ë´‡ì€ ì•„ì§ ì‚´ì•„ìˆìŒ)
          Write-Host "ğŸ”¨ Building new binary to temp file..."
          go build -o d3k-agent-new.exe ./cmd/d3k-agent
          if (!(Test-Path "./d3k-agent-new.exe")) { throw "Build Failed!" }
          Write-Host "âœ… New version built successfully."

      - name: Swap and Launch
        shell: powershell
        env:
          # ì¤‘ìš”: ê¹ƒí—ˆë¸Œ ëŸ¬ë„ˆê°€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¶”ì í•˜ì—¬ ê°•ì œë¡œ ì£½ì´ëŠ” ê²ƒì„ ë°©ì§€
          RUNNER_TRACKING_ID: ""
        run: |
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot

          # 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (êµì²´ ì§ì „ì—ë§Œ)
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "ğŸ›‘ Stopping old agent for update..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 2
          }

          # 2. ë°”ì´ë„ˆë¦¬ êµì²´
          Move-Item -Path "./d3k-agent-new.exe" -Destination "./d3k-agent.exe" -Force

          # 3. ìƒˆ ì°½ì—ì„œ ì‹¤í–‰ (ë°°í¬ ì‘ì—… ì¢…ë£Œ í›„ì—ë„ ì‚´ì•„ë‚¨ë„ë¡ ì²˜ë¦¬)
          Write-Host "ğŸš€ Launching new agent window..."
          # Start-Processë¥¼ í†µí•´ ì™„ì „íˆ ë…ë¦½ëœ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰
          Start-Process "powershell.exe" -ArgumentList "-NoExit", "-Command", "& './d3k-agent.exe'" -WorkingDirectory $projectRoot
          
          Write-Host "âœ¨ Update Complete! The bot window should be visible and persistent."
