name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Stop existing process
        shell: powershell
        run: |
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "ðŸ›‘ Stopping existing d3k-agent process..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 3
          }

      - name: Build Go binary
        shell: powershell
        run: |
          Write-Host "ðŸ”¨ Building Go binary..."
          go build -o d3k-agent.exe ./cmd/d3k-agent
          if (!(Test-Path "./d3k-agent.exe")) {
              throw "Build failed: d3k-agent.exe not created"
          }

      - name: Run D3K Agent
        shell: powershell
        run: |
          Write-Host "ðŸš€ Starting D3K Agent in background..."
          # Start-Process with explicit working directory
          $workDir = Get-Location
          Start-Process -FilePath "./d3k-agent.exe" -WorkingDirectory $workDir -NoNewWindow -RedirectStandardOutput "./bot_output.log" -RedirectStandardError "./bot_error.log"
          Write-Host "âœ… Deployment complete. Log saved to bot_output.log"