name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Build New Binary
        shell: powershell
        run: |
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot
          Write-Host "ğŸ”¨ Building new version..."
          go build -o d3k-agent-new.exe ./cmd/d3k-agent
          if (!(Test-Path "./d3k-agent-new.exe")) { throw "Build Failed!" }

      - name: Hard Reset and Launch
        shell: powershell
        env:
          RUNNER_TRACKING_ID: ""
        run: |
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot

          Write-Host "ğŸ›‘ Killing existing agent processes and windows..."
          # 1. d3k-agent.exe í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          taskkill /F /IM d3k-agent.exe /T 2>$null
          
          # 2. íŠ¹ì • íƒ€ì´í‹€ì„ ê°€ì§„ PowerShell ì°½ ì¢…ë£Œ (ë‚˜ì¤‘ì— ì‹¤í–‰í•  ë•Œ íƒ€ì´í‹€ì„ ë¶€ì—¬í•  ì˜ˆì •)
          Get-Process powershell -ErrorAction SilentlyContinue | Where-Object { $_.MainWindowTitle -like "*D3K-AGENT-WINDOW*" } | Stop-Process -Force -ErrorAction SilentlyContinue
          
          Start-Sleep -Seconds 2

          # 3. íŒŒì¼ êµì²´
          Move-Item -Path "./d3k-agent-new.exe" -Destination "./d3k-agent.exe" -Force

          # 4. ìƒˆ ì°½ì—ì„œ ê³ ìœ  íƒ€ì´í‹€ê³¼ í•¨ê»˜ ì‹¤í–‰
          Write-Host "ğŸš€ Launching version [v1.0.3] in a new window..."
          $cmd = "`$Host.UI.RawUI.WindowTitle = 'D3K-AGENT-WINDOW'; ./d3k-agent.exe"
          Start-Process "powershell.exe" -ArgumentList "-NoExit", "-Command", $cmd -WorkingDirectory $projectRoot
          
          Write-Host "âœ¨ Deployment Successful. Old windows cleaned up."