name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Stop existing process
        shell: powershell
        run: |
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "üõë Stopping existing d3k-agent process..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 3
          }

      - name: Build Go binary
        shell: powershell
        run: |
          Write-Host "üî® Building Go binary..."
          # Build from root using standard Go module path
          go build -o d3k-agent.exe ./cmd/d3k-agent
          
          if (Test-Path "./d3k-agent.exe") {
              Write-Host "‚úÖ Build Success: d3k-agent.exe created."
          } else {
              # Try fallback build if directory structure is weird
              Write-Host "‚ö†Ô∏è Path issue? Trying fallback build from subdir..."
              cd cmd/d3k-agent
              go build -o ../../d3k-agent.exe
              cd ../..
          }
          
          if (!(Test-Path "./d3k-agent.exe")) {
              throw "Build failed: d3k-agent.exe not created"
          }

      - name: Run D3K Agent
        shell: powershell
        run: |
          Write-Host "üöÄ Starting D3K Agent..."
          $workDir = Get-Location
          # Ensure .env exists
          if (!(Test-Path "./.env")) {
              Write-Host "‚ö†Ô∏è Warning: .env file not found in $workDir"
          }
          Start-Process -FilePath "./d3k-agent.exe" -WorkingDirectory $workDir -NoNewWindow -RedirectStandardOutput "./bot_output.log" -RedirectStandardError "./bot_error.log"
          Write-Host "‚úÖ Deployment complete."