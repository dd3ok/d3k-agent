name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Deploy Process
        shell: powershell
        run: |
          # 1. Find Project Root using successful logic
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          if (!$mainFile) { throw "Fatal: main.go not found!" }
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot
          Write-Host "üè† Project Root: $projectRoot"

          # 2. Stop existing process
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "üõë Stopping existing d3k-agent process..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 3
          }

          # 3. Build Go binary
          Write-Host "üî® Building Go binary..."
          go build -o d3k-agent.exe ./cmd/d3k-agent
          if (!(Test-Path "./d3k-agent.exe")) {
              throw "Build failed: d3k-agent.exe not created"
          }

          # 4. Run D3K Agent
          Write-Host "üöÄ Starting D3K Agent in background..."
          # Ensure .env existence check
          if (!(Test-Path "./.env")) {
              Write-Host "‚ö†Ô∏è Warning: .env file not found in $projectRoot. Please copy it manually!"
          }
          # Start the process and redirect logs
          Start-Process -FilePath "./d3k-agent.exe" -WorkingDirectory $projectRoot -NoNewWindow -RedirectStandardOutput "./bot_output.log" -RedirectStandardError "./bot_error.log"
          Write-Host "‚úÖ Deployment complete. Agent is running in the background."