name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          clean: false  # ì¤‘ìš”: .env ê°™ì€ ë¡œì»¬ íŒŒì¼ì„ ì§€ìš°ì§€ ì•Šë„ë¡ ì„¤ì •

      - name: Deploy Process
        shell: powershell
        run: |
          # 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          if (!$mainFile) { throw "Fatal: main.go not found!" }
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot
          Write-Host "ğŸ  Project Root: $projectRoot"

          # 2. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "ğŸ›‘ Stopping existing d3k-agent process..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 3
          }

          # 3. .env íŒŒì¼ ì²´í¬
          if (!(Test-Path "./.env")) {
              Write-Host "âŒ FATAL: .env file is missing! Please put it in: $projectRoot"
              throw ".env file missing"
          }

          # 4. ë¹Œë“œ Go binary
          Write-Host "ğŸ”¨ Building Go binary..."
          go build -o d3k-agent.exe ./cmd/d3k-agent
          if (!(Test-Path "./d3k-agent.exe")) {
              throw "Build failed: d3k-agent.exe not created"
          }

          # 5. ì‹¤í–‰
          Write-Host "ğŸš€ Starting D3K Agent in background..."
          $workDir = Get-Location
          # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™”
          New-Item -ItemType File -Path "./bot_output.log" -Force | Out-Null
          
          Start-Process -FilePath "./d3k-agent.exe" -WorkingDirectory $workDir -NoNewWindow -RedirectStandardOutput "./bot_output.log" -RedirectStandardError "./bot_error.log"
          
          Start-Sleep -Seconds 5 # ë´‡ì´ ì¼œì§ˆ ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
          
          Write-Host "ğŸ“Š Checking Startup Logs:"
          if (Test-Path "./bot_output.log") {
              Get-Content "./bot_output.log" -Head 10
          }
          
          Write-Host "âœ… Deployment complete. Agent is running."
