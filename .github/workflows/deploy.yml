name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Deploy Process
        shell: powershell
        run: |
          # 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          if (!$mainFile) { throw "Fatal: main.go not found!" }
          $projectRoot = $mainFile.Directory.Parent.Parent.FullName
          cd $projectRoot

          # 2. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "ğŸ›‘ Stopping existing agent..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 2
          }

          # 3. ë¹Œë“œ
          Write-Host "ğŸ”¨ Building..."
          go build -o d3k-agent.exe ./cmd/d3k-agent

          # 4. ìƒˆ ì°½ì—ì„œ ì‹¤í–‰ (Interactive Window)
          # 'powershell.exe'ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì°½ì„ ë„ìš°ê³  ê·¸ ì•ˆì—ì„œ ë´‡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
          Write-Host "ğŸš€ Launching Agent in a NEW Terminal Window..."
          Start-Process "powershell.exe" -ArgumentList "-NoExit", "-Command", "& './d3k-agent.exe'" -WorkingDirectory $projectRoot
          
          Write-Host "âœ… Done! A new terminal window should have opened on your laptop."