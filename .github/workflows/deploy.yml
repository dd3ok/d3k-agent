name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: System - Deep Directory Scan
        shell: powershell
        run: |
          Write-Host "üîç Current Location: $(Get-Location)"
          Write-Host "üìÇ FULL RECURSIVE DIRECTORY LISTING:"
          Get-ChildItem -Recurse -Name | Select-Object -First 50
          
          $target = "main.go"
          $found = Get-ChildItem -Filter $target -Recurse -ErrorAction SilentlyContinue
          if ($found) {
              Write-Host "üéØ Found main.go at: $($found.FullName)"
              $rootPath = $found.Directory.Parent.Parent.FullName
              Write-Host "üöÄ Detected Project Root: $rootPath"
          } else {
              Write-Host "‚ùå FATAL: main.go NOT found anywhere!"
          }

      - name: Simple Build
        shell: powershell
        run: |
          $mainFile = Get-ChildItem -Filter "main.go" -Recurse | Select-Object -First 1
          if ($mainFile) {
              $projectRoot = $mainFile.Directory.Parent.Parent.FullName
              cd $projectRoot
              Write-Host "üî® Building from $projectRoot"
              go build -o d3k-agent.exe ./cmd/d3k-agent
          }
