name: Auto Deploy to Home Laptop

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Run
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Debug - List Files
        shell: powershell
        run: |
          Write-Host "üìÇ Current Directory: $(Get-Location)"
          Write-Host "üìÑ Listing files in root:"
          ls
          if (Test-Path "./cmd") {
              Write-Host "‚úÖ 'cmd' directory found."
              ls ./cmd
          } else {
              Write-Host "‚ùå 'cmd' directory NOT found."
          }

      - name: Stop existing process
        shell: powershell
        run: |
          $proc = Get-Process -Name "d3k-agent" -ErrorAction SilentlyContinue
          if ($proc) {
              Write-Host "üõë Stopping existing d3k-agent process..."
              Stop-Process -Name "d3k-agent" -Force
              Start-Sleep -Seconds 3
          }

      - name: Build Go binary
        shell: powershell
        run: |
          Write-Host "üî® Building Go binary..."
          # Use absolute path-like syntax for Windows Go build
          go build -o d3k-agent.exe ./cmd/d3k-agent/
          if (!(Test-Path "./d3k-agent.exe")) {
              throw "Build failed: d3k-agent.exe not created"
          }

      - name: Run D3K Agent
        shell: powershell
        run: |
          Write-Host "üöÄ Starting D3K Agent in background..."
          $workDir = Get-Location
          # Ensure log files exist or are cleared
          New-Item -ItemType File -Path "./bot_output.log" -Force | Out-Null
          Start-Process -FilePath "./d3k-agent.exe" -WorkingDirectory $workDir -NoNewWindow -RedirectStandardOutput "./bot_output.log" -RedirectStandardError "./bot_error.log"
          Write-Host "‚úÖ Deployment complete. Check bot_output.log for details."
